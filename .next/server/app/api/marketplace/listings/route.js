"use strict";(()=>{var e={};e.id=457,e.ids=[457],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9692:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>w,patchFetch:()=>_,requestAsyncStorage:()=>f,routeModule:()=>m,serverHooks:()=>y,staticGenerationAsyncStorage:()=>h});var i={};t.r(i),t.d(i,{GET:()=>d,OPTIONS:()=>g,POST:()=>p,runtime:()=>u});var a=t(9303),n=t(8716),s=t(670),o=t(4664),l=t(8387),c=t(9161);let u="nodejs";function g(){return(0,o.U1)()}async function d(e){try{if(!l.OQ)return(0,o.wE)({error:"database_not_available",message:"Supabase not configured",listings:[]},503);let{searchParams:r}=new URL(e.url),t=r.get("keyword"),i=r.get("category"),a=r.get("city"),n=r.get("district"),s=r.get("village"),u=r.get("status")||"active",g=r.get("sort")||"newest",d=r.get("page")||"1",p=r.get("limit")||"20",m=r.get("province"),f=Math.max(1,parseInt(d,10)||1),h=Math.min(100,Math.max(1,parseInt(p,10)||20)),y=(f-1)*h,w=l.OQ.from("marketplace_listings").select("*, images, seller_id",{count:"exact"});switch(u&&(w=w.eq("status",u)),i&&(w=w.eq("category",i)),m&&(w=w.eq("location_province",m)),a&&(w=w.eq("location_city",a)),n&&(w=w.eq("location_district",n)),s&&(w=w.eq("location_village",s)),t&&t.trim()&&(w=w.textSearch("search_text",t.trim(),{type:"websearch",config:"indonesian"})),g){case"newest":case"relevance":default:w=w.order("created_at",{ascending:!1});break;case"oldest":w=w.order("created_at",{ascending:!0});break;case"price_low":w=w.order("price",{ascending:!0,nullsLast:!0});break;case"price_high":w=w.order("price",{ascending:!1,nullsLast:!0});break;case"location":w=w.order("location_city",{ascending:!0}).order("location_district",{ascending:!0}).order("location_village",{ascending:!0})}w=w.range(y,y+h-1);let{data:_,error:E,count:S}=await w;if(E)return console.error("Error fetching listings:",E),(0,o.wE)({error:"database_error",message:E.message,listings:[]},500);let b=(_||[]).map(e=>(0,c.cu)(e));return(0,o.wE)({listings:b,pagination:{page:f,limit:h,total:S||0,totalPages:Math.ceil((S||0)/h)}})}catch(e){return console.error("Exception fetching listings:",e),(0,o.wE)({error:"server_error",message:e.message,listings:[]},500)}}async function p(e){try{if(!l.OQ)return(0,o.wE)({error:"database_not_available",message:"Supabase not configured"},503);let r=e.headers.get("x-user-email");if(!r)return(0,o.wE)({error:"unauthorized",message:"Email user diperlukan (header x-user-email)"},401);let t=await (0,l.WB)(r);if(!t)return(0,o.wE)({error:"user_not_found",message:"User tidak ditemukan"},404);let{title:i,description:a,category:n,tags:s=[],price:u=0,images:g=[],location_province:d,location_city:p,location_district:m,location_village:f,use_ai:h=!1}=await (0,o.zr)(e)||{},y=(0,c.aH)(g);if(!i||!a||!n)return(0,o.wE)({error:"validation_error",message:"Title, description, dan category wajib diisi"},400);let w=`${i} ${a} ${s.join(" ")}`.toLowerCase(),_=t.id,E=await (0,l.Qr)(r);E?(_=E,console.log(`Using auth.users.id for seller: ${_}`)):(console.warn(`Auth user ID not found/created for ${r}, using users.id: ${t.id}`),_=t.id);let{data:S,error:b}=await l.OQ.from("marketplace_listings").insert({seller_id:_,seller_email:(0,l.R)(r),title:i.trim(),description:a.trim(),category:n.trim(),tags:Array.isArray(s)?s:[],price:parseFloat(u)||0,images:y,location_province:d?.trim()||null,location_city:p?.trim()||null,location_district:m?.trim()||null,location_village:f?.trim()||null,status:"active",ai_generated:h||!1,search_text:w}).select().single();if(b)return console.error("Error creating listing:",b),(0,o.wE)({error:"database_error",message:b.message},500);return console.log("Listing created:",S.id),(0,o.wE)({listing:S,message:"Listing berhasil dibuat"},201)}catch(e){return console.error("Exception creating listing:",e),(0,o.wE)({error:"server_error",message:e.message},500)}}let m=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/marketplace/listings/route",pathname:"/api/marketplace/listings",filename:"route",bundlePath:"app/api/marketplace/listings/route"},resolvedPagePath:"D:\\Semester 3\\FSD\\SampahKuPilah - Copy\\SampahKuPilah\\app\\api\\marketplace\\listings\\route.js",nextConfigOutput:"",userland:i}),{requestAsyncStorage:f,staticGenerationAsyncStorage:h,serverHooks:y}=m,w="/api/marketplace/listings/route";function _(){return(0,s.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:h})}},4664:(e,r,t)=>{t.d(r,{U1:()=>n,wE:()=>a,zr:()=>s});let i={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET,POST,PUT,DELETE,OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization, X-User-Email"};function a(e,r=200,t={}){return new Response(JSON.stringify(e),{status:r,headers:{"Content-Type":"application/json",...i,...t}})}function n(){return new Response(null,{status:204,headers:i})}async function s(e){try{return await e.json()}catch{return null}}},9161:(e,r,t)=>{t.d(r,{IT:()=>n,aH:()=>o,cu:()=>s,dI:()=>a});var i=t(8387);function a(){let e=new Date().toISOString().slice(0,10).replace(/-/g,""),r=Math.random().toString(36).substring(2,6).toUpperCase();return`ORD-${e}-${r}`}function n(){let e=Date.now(),r=Math.random().toString(36).substring(2,8).toUpperCase();return`MSG-${e}-${r}`}function s(e){if(!e)return e;let r={...e};if(r.images){if("string"==typeof r.images)try{r.images=JSON.parse(r.images)}catch{r.images=r.images.trim()?[r.images.trim()]:[]}Array.isArray(r.images)||(r.images=[])}else r.images=[];return r}function o(e=[]){let r=[];if(!Array.isArray(e)||0===e.length)return r;for(let t of e){if("string"==typeof t){t.startsWith("http://")||t.startsWith("https://")||t.startsWith("data:")?r.push(t):t.trim().length>0&&r.push(t.trim());continue}if("object"==typeof t&&null!==t){if(t.url)r.push(t.url);else if(t.base64&&t.mimeType)r.push(`data:${t.mimeType};base64,${t.base64}`);else if(t.path&&i.NF){let e=`${i.NF}/storage/v1/object/public/marketplace-images/${t.path}`;r.push(e)}}}return r}},8387:(e,r,t)=>{t.d(r,{Ix:()=>g,NF:()=>a,OQ:()=>l,Oo:()=>p,Qr:()=>d,R:()=>c,WB:()=>u,mI:()=>m});var i=t(4128);let a=process.env.SUPABASE_URL?.trim()||"",n=process.env.SUPABASE_SERVICE_ROLE?.trim()||process.env.SUPABASE_SERVICE_KEY?.trim()||"",s=process.env.SUPABASE_ANON_KEY?.trim()||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2c2VhZWhmcXJ4emt2b2VqZ3VqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MzI2NjYsImV4cCI6MjA3OTEwODY2Nn0.Jp9SN_U-xJBay1uhyiGVKbyF9Tjsuse5QxHiBeH5S7U".trim()||"",o=n||s,l=a&&o?(0,i.eI)(a,o):null,c=e=>"string"==typeof e?e.trim().toLowerCase():"";async function u(e){if(!l)return null;try{let r=c(e),{data:t,error:i}=await l.from("users").select("*").eq("email",r).single();if(i)return"PGRST116"!==i.code&&console.error("Error finding user in Supabase:",i),null;return t}catch(e){return console.error("Exception finding user in Supabase:",e),null}}async function g(e){if(!l)return null;try{let{data:r,error:t}=await l.from("users").insert({email:c(e.email),password_hash:e.passwordHash||null,provider:e.provider||"local",name:e.name||null,picture:e.picture||null}).select().single();if(t)return console.error("Error creating user in Supabase:",t),null;return r}catch(e){return console.error("Exception creating user in Supabase:",e),null}}async function d(e){if(!a||!n)return null;try{let r=c(e),t=await fetch(`${a}/auth/v1/admin/users`,{method:"GET",headers:{apikey:n,Authorization:`Bearer ${n}`,"Content-Type":"application/json"}});if(t.ok){let e=await t.json();if(e?.users&&Array.isArray(e.users)){let t=e.users.find(e=>e.email&&e.email.toLowerCase()===r);if(t?.id)return console.log(`Found auth user for ${r}: ${t.id}`),t.id}}else{let e=await t.text();console.warn("Error listing auth users:",e.substring(0,200))}let i=await fetch(`${a}/auth/v1/admin/users`,{method:"POST",headers:{apikey:n,Authorization:`Bearer ${n}`,"Content-Type":"application/json"},body:JSON.stringify({email:r,email_confirm:!0,user_metadata:{}})});if(i.ok){let e=await i.json();if(e?.user?.id)return console.log(`Created auth user for ${r}: ${e.user.id}`),e.user.id}else{let e=await i.text();console.error("Error creating auth user:",e.substring(0,200))}return console.warn(`Auth user ID not found/created for ${r}`),null}catch(e){return console.error("Error getting/creating auth user ID:",e.message),null}}async function p(e,r){if(!l)return null;try{let{data:t,error:i}=await l.from("detections").insert({user_email:c(e),category:r.category||r.bin||"abu-abu",bin_name:r.bin_name||r.dominant_class||"Residu",confidence:r.confidence||.8,reason:r.reason||"Auto-detected",created_at:new Date().toISOString()}).select().single();if(i)return console.error("Error saving detection to Supabase:",i),null;return console.log("Detection saved to Supabase:",t.id),t}catch(e){return console.error("Exception saving detection to Supabase:",e),null}}async function m(e,r=50){if(!l)return[];try{let{data:t,error:i}=await l.from("detections").select("*").eq("user_email",c(e)).order("created_at",{ascending:!1}).limit(r);if(i)return console.error("Error fetching detections from Supabase:",i),[];return t||[]}catch(e){return console.error("Exception fetching detections from Supabase:",e),[]}}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),i=r.X(0,[948,885],()=>t(9692));module.exports=i})();