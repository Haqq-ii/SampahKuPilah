"use strict";(()=>{var e={};e.id=5,e.ids=[5],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8065:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>g,patchFetch:()=>h,requestAsyncStorage:()=>p,routeModule:()=>m,serverHooks:()=>f,staticGenerationAsyncStorage:()=>_});var a={};t.r(a),t.d(a,{OPTIONS:()=>d,PUT:()=>c,runtime:()=>u});var s=t(9303),i=t(8716),n=t(670),o=t(4664),l=t(8387);let u="nodejs";function d(){return(0,o.U1)()}async function c(e,{params:r}){try{if(!l.OQ)return(0,o.wE)({error:"database_not_available",message:"Supabase not configured"},503);let{id:t}=r,a=e.headers.get("x-user-email");if(!a)return(0,o.wE)({error:"unauthorized",message:"Email user diperlukan"},401);let{status:s,cod_location:i,cod_time:n}=await (0,o.zr)(e)||{};if(!s)return(0,o.wE)({error:"validation_error",message:"Status wajib diisi"},400);let u=["pending","deal","done","canceled"];if(!u.includes(s))return(0,o.wE)({error:"invalid_status",message:`Status harus salah satu dari: ${u.join(", ")}`},400);let{data:d,error:c}=await l.OQ.from("marketplace_orders").select("*").eq("id",t).single();if(c||!d)return(0,o.wE)({error:"not_found",message:"Order tidak ditemukan"},404);let m=(0,l.R)(a);if(d.buyer_email!==m&&d.seller_email!==m)return(0,o.wE)({error:"forbidden",message:"Tidak memiliki akses untuk update order ini"},403);if("done"===s&&d.seller_email!==m)return(0,o.wE)({error:"forbidden",message:"Hanya penjual yang bisa menandai order sebagai selesai"},403);let p={status:s,updated_at:new Date().toISOString()};i&&(p.cod_location=i.trim()),n&&(p.cod_time=n);let{data:_,error:f}=await l.OQ.from("marketplace_orders").update(p).eq("id",t).select().single();if(f)return console.error("Error updating order:",f),(0,o.wE)({error:"database_error",message:f.message},500);if("done"===s){await l.OQ.from("marketplace_listings").update({status:"sold",updated_at:new Date().toISOString()}).eq("id",d.listing_id);let e=await l.OQ.from("user_stats").select("*").eq("user_email",d.seller_email).single();e.data?await l.OQ.from("user_stats").update({total_items_sold:(e.data.total_items_sold||0)+1,points_seller:(e.data.points_seller||0)+10,total_points:(e.data.points_seller||0)+10+(e.data.points_buyer||0),updated_at:new Date().toISOString()}).eq("user_email",d.seller_email):await l.OQ.from("user_stats").insert({user_email:d.seller_email,total_items_sold:1,points_seller:10,total_points:10});let r=await l.OQ.from("user_stats").select("*").eq("user_email",d.buyer_email).single();r.data?await l.OQ.from("user_stats").update({total_items_bought:(r.data.total_items_bought||0)+1,points_buyer:(r.data.points_buyer||0)+5,total_points:(r.data.points_seller||0)+(r.data.points_buyer||0)+5,updated_at:new Date().toISOString()}).eq("user_email",d.buyer_email):await l.OQ.from("user_stats").insert({user_email:d.buyer_email,total_items_bought:1,points_buyer:5,total_points:5}),console.log("Order marked as done, stats updated")}return(0,o.wE)({order:_,message:"Status order berhasil diupdate"})}catch(e){return console.error("Exception updating order:",e),(0,o.wE)({error:"server_error",message:e.message},500)}}let m=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/marketplace/orders/[id]/status/route",pathname:"/api/marketplace/orders/[id]/status",filename:"route",bundlePath:"app/api/marketplace/orders/[id]/status/route"},resolvedPagePath:"D:\\Semester 3\\FSD\\SampahKuPilah - Copy\\SampahKuPilah\\app\\api\\marketplace\\orders\\[id]\\status\\route.js",nextConfigOutput:"",userland:a}),{requestAsyncStorage:p,staticGenerationAsyncStorage:_,serverHooks:f}=m,g="/api/marketplace/orders/[id]/status/route";function h(){return(0,n.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:_})}},4664:(e,r,t)=>{t.d(r,{U1:()=>i,wE:()=>s,zr:()=>n});let a={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET,POST,PUT,DELETE,OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization, X-User-Email"};function s(e,r=200,t={}){return new Response(JSON.stringify(e),{status:r,headers:{"Content-Type":"application/json",...a,...t}})}function i(){return new Response(null,{status:204,headers:a})}async function n(e){try{return await e.json()}catch{return null}}},8387:(e,r,t)=>{t.d(r,{Ix:()=>c,NF:()=>s,OQ:()=>l,Oo:()=>p,Qr:()=>m,R:()=>u,WB:()=>d,mI:()=>_});var a=t(4128);let s=process.env.SUPABASE_URL?.trim()||"",i=process.env.SUPABASE_SERVICE_ROLE?.trim()||process.env.SUPABASE_SERVICE_KEY?.trim()||"",n=process.env.SUPABASE_ANON_KEY?.trim()||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2c2VhZWhmcXJ4emt2b2VqZ3VqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MzI2NjYsImV4cCI6MjA3OTEwODY2Nn0.Jp9SN_U-xJBay1uhyiGVKbyF9Tjsuse5QxHiBeH5S7U".trim()||"",o=i||n,l=s&&o?(0,a.eI)(s,o):null,u=e=>"string"==typeof e?e.trim().toLowerCase():"";async function d(e){if(!l)return null;try{let r=u(e),{data:t,error:a}=await l.from("users").select("*").eq("email",r).single();if(a)return"PGRST116"!==a.code&&console.error("Error finding user in Supabase:",a),null;return t}catch(e){return console.error("Exception finding user in Supabase:",e),null}}async function c(e){if(!l)return null;try{let{data:r,error:t}=await l.from("users").insert({email:u(e.email),password_hash:e.passwordHash||null,provider:e.provider||"local",name:e.name||null,picture:e.picture||null}).select().single();if(t)return console.error("Error creating user in Supabase:",t),null;return r}catch(e){return console.error("Exception creating user in Supabase:",e),null}}async function m(e){if(!s||!i)return null;try{let r=u(e),t=await fetch(`${s}/auth/v1/admin/users`,{method:"GET",headers:{apikey:i,Authorization:`Bearer ${i}`,"Content-Type":"application/json"}});if(t.ok){let e=await t.json();if(e?.users&&Array.isArray(e.users)){let t=e.users.find(e=>e.email&&e.email.toLowerCase()===r);if(t?.id)return console.log(`Found auth user for ${r}: ${t.id}`),t.id}}else{let e=await t.text();console.warn("Error listing auth users:",e.substring(0,200))}let a=await fetch(`${s}/auth/v1/admin/users`,{method:"POST",headers:{apikey:i,Authorization:`Bearer ${i}`,"Content-Type":"application/json"},body:JSON.stringify({email:r,email_confirm:!0,user_metadata:{}})});if(a.ok){let e=await a.json();if(e?.user?.id)return console.log(`Created auth user for ${r}: ${e.user.id}`),e.user.id}else{let e=await a.text();console.error("Error creating auth user:",e.substring(0,200))}return console.warn(`Auth user ID not found/created for ${r}`),null}catch(e){return console.error("Error getting/creating auth user ID:",e.message),null}}async function p(e,r){if(!l)return null;try{let{data:t,error:a}=await l.from("detections").insert({user_email:u(e),category:r.category||r.bin||"abu-abu",bin_name:r.bin_name||r.dominant_class||"Residu",confidence:r.confidence||.8,reason:r.reason||"Auto-detected",created_at:new Date().toISOString()}).select().single();if(a)return console.error("Error saving detection to Supabase:",a),null;return console.log("Detection saved to Supabase:",t.id),t}catch(e){return console.error("Exception saving detection to Supabase:",e),null}}async function _(e,r=50){if(!l)return[];try{let{data:t,error:a}=await l.from("detections").select("*").eq("user_email",u(e)).order("created_at",{ascending:!1}).limit(r);if(a)return console.error("Error fetching detections from Supabase:",a),[];return t||[]}catch(e){return console.error("Exception fetching detections from Supabase:",e),[]}}}};var r=require("../../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[948,885],()=>t(8065));module.exports=a})();