"use strict";(()=>{var e={};e.id=53,e.ids=[53],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3499:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>w,patchFetch:()=>y,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>f,staticGenerationAsyncStorage:()=>h});var a={};t.r(a),t.d(a,{OPTIONS:()=>p,POST:()=>d,runtime:()=>c});var n=t(9303),i=t(8716),o=t(670),s=t(4664),u=t(3514),l=t(8387);let c="nodejs";function p(){return(0,s.U1)()}async function d(e){try{let r;if(!l.OQ)return(0,s.wE)({error:"database_not_available",message:"Supabase not configured"},503);if(!e.headers.get("x-user-email"))return(0,s.wE)({error:"unauthorized",message:"Email user diperlukan"},401);let{base64:t,mimeType:a,filename:n,enhance:i=!1}=await (0,s.zr)(e)||{};if(!t||!a)return(0,s.wE)({error:"validation_error",message:"base64 dan mimeType diperlukan"},400);let o=t,c=a;if(i)try{let e=(0,u.N)(t),a=await (0,u.p)(e);r=a.buffer,o=a.base64,c=a.mimeType}catch(e){console.warn("Image enhancement failed, using original:",e.message),r=(0,u.N)(t)}else r=(0,u.N)(t);let p=c.split("/")[1]||"jpg",d=(n||`image-${Date.now()}`).replace(/[^a-zA-Z0-9.-]/g,"_").substring(0,100),m=`listings/${Date.now()}-${d}.${p}`,{error:g}=await l.OQ.storage.from("marketplace-images").upload(m,r,{contentType:c,upsert:!1});if(g){console.error("Error uploading to Supabase Storage:",g);let e=`data:${c};base64,${o}`;return(0,s.wE)({url:e,path:null,isDataUrl:!0,enhanced:i})}let{data:h}=l.OQ.storage.from("marketplace-images").getPublicUrl(m);return(0,s.wE)({url:h.publicUrl,path:m,isDataUrl:!1,enhanced:i})}catch(e){return console.error("Exception uploading image:",e),(0,s.wE)({error:"server_error",message:e.message},500)}}let m=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/marketplace/upload-image/route",pathname:"/api/marketplace/upload-image",filename:"route",bundlePath:"app/api/marketplace/upload-image/route"},resolvedPagePath:"D:\\Semester 3\\FSD\\SampahKuPilah - Copy\\SampahKuPilah\\app\\api\\marketplace\\upload-image\\route.js",nextConfigOutput:"",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:h,serverHooks:f}=m,w="/api/marketplace/upload-image/route";function y(){return(0,o.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:h})}},4664:(e,r,t)=>{t.d(r,{U1:()=>i,wE:()=>n,zr:()=>o});let a={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET,POST,PUT,DELETE,OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization, X-User-Email"};function n(e,r=200,t={}){return new Response(JSON.stringify(e),{status:r,headers:{"Content-Type":"application/json",...a,...t}})}function i(){return new Response(null,{status:204,headers:a})}async function o(e){try{return await e.json()}catch{return null}}},3514:(e,r,t)=>{t.d(r,{N:()=>n,p:()=>i});let a=require("sharp");function n(e){return Buffer.from(e,"base64")}async function i(e){let r=await a(e).metadata(),t=r.width,n=r.height;t&&n&&(t>1920||n>1920)&&(t>n?(t=1920,n=Math.round(r.height/r.width*1920)):(n=1920,t=Math.round(r.width/r.height*1920)));let i=a(e);t&&n&&(i=i.resize(t,n,{fit:"inside",withoutEnlargement:!0}));let o=await i.modulate({brightness:1.05,saturation:1.1}).sharpen({sigma:1,flat:1,jagged:2}).normalize().jpeg({quality:85,progressive:!0,mozjpeg:!0}).toBuffer(),s=e.length>0?`${Math.round((1-o.length/e.length)*100)}%`:"0%";return{buffer:o,base64:o.toString("base64"),mimeType:"image/jpeg",width:t||r.width||null,height:n||r.height||null,originalWidth:r.width||null,originalHeight:r.height||null,sizeReduction:s}}},8387:(e,r,t)=>{t.d(r,{Ix:()=>p,NF:()=>n,OQ:()=>u,Oo:()=>m,Qr:()=>d,R:()=>l,WB:()=>c,mI:()=>g});var a=t(4128);let n=process.env.SUPABASE_URL?.trim()||"",i=process.env.SUPABASE_SERVICE_ROLE?.trim()||process.env.SUPABASE_SERVICE_KEY?.trim()||"",o=process.env.SUPABASE_ANON_KEY?.trim()||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2c2VhZWhmcXJ4emt2b2VqZ3VqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MzI2NjYsImV4cCI6MjA3OTEwODY2Nn0.Jp9SN_U-xJBay1uhyiGVKbyF9Tjsuse5QxHiBeH5S7U".trim()||"",s=i||o,u=n&&s?(0,a.eI)(n,s):null,l=e=>"string"==typeof e?e.trim().toLowerCase():"";async function c(e){if(!u)return null;try{let r=l(e),{data:t,error:a}=await u.from("users").select("*").eq("email",r).single();if(a)return"PGRST116"!==a.code&&console.error("Error finding user in Supabase:",a),null;return t}catch(e){return console.error("Exception finding user in Supabase:",e),null}}async function p(e){if(!u)return null;try{let{data:r,error:t}=await u.from("users").insert({email:l(e.email),password_hash:e.passwordHash||null,provider:e.provider||"local",name:e.name||null,picture:e.picture||null}).select().single();if(t)return console.error("Error creating user in Supabase:",t),null;return r}catch(e){return console.error("Exception creating user in Supabase:",e),null}}async function d(e){if(!n||!i)return null;try{let r=l(e),t=await fetch(`${n}/auth/v1/admin/users`,{method:"GET",headers:{apikey:i,Authorization:`Bearer ${i}`,"Content-Type":"application/json"}});if(t.ok){let e=await t.json();if(e?.users&&Array.isArray(e.users)){let t=e.users.find(e=>e.email&&e.email.toLowerCase()===r);if(t?.id)return console.log(`Found auth user for ${r}: ${t.id}`),t.id}}else{let e=await t.text();console.warn("Error listing auth users:",e.substring(0,200))}let a=await fetch(`${n}/auth/v1/admin/users`,{method:"POST",headers:{apikey:i,Authorization:`Bearer ${i}`,"Content-Type":"application/json"},body:JSON.stringify({email:r,email_confirm:!0,user_metadata:{}})});if(a.ok){let e=await a.json();if(e?.user?.id)return console.log(`Created auth user for ${r}: ${e.user.id}`),e.user.id}else{let e=await a.text();console.error("Error creating auth user:",e.substring(0,200))}return console.warn(`Auth user ID not found/created for ${r}`),null}catch(e){return console.error("Error getting/creating auth user ID:",e.message),null}}async function m(e,r){if(!u)return null;try{let{data:t,error:a}=await u.from("detections").insert({user_email:l(e),category:r.category||r.bin||"abu-abu",bin_name:r.bin_name||r.dominant_class||"Residu",confidence:r.confidence||.8,reason:r.reason||"Auto-detected",created_at:new Date().toISOString()}).select().single();if(a)return console.error("Error saving detection to Supabase:",a),null;return console.log("Detection saved to Supabase:",t.id),t}catch(e){return console.error("Exception saving detection to Supabase:",e),null}}async function g(e,r=50){if(!u)return[];try{let{data:t,error:a}=await u.from("detections").select("*").eq("user_email",l(e)).order("created_at",{ascending:!1}).limit(r);if(a)return console.error("Error fetching detections from Supabase:",a),[];return t||[]}catch(e){return console.error("Exception fetching detections from Supabase:",e),[]}}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[948,885],()=>t(3499));module.exports=a})();