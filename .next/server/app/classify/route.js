"use strict";(()=>{var e={};e.id=155,e.ids=[155],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5579:(e,a,r)=>{r.r(a),r.d(a,{originalPathname:()=>b,patchFetch:()=>_,requestAsyncStorage:()=>k,routeModule:()=>f,serverHooks:()=>h,staticGenerationAsyncStorage:()=>y});var n={};r.r(n),r.d(n,{OPTIONS:()=>g,POST:()=>p,runtime:()=>l});var t=r(9303),i=r(8716),s=r(670),o=r(4664),u=r(9665),c=r(8387);let l="nodejs",d=!1,m=0;function g(){return(0,o.U1)()}async function p(e){try{let a=(0,u.JA)();if(!a.ok)return(0,o.wE)({error:a.error,message:a.message},500);if(!u.fr)return(0,o.wE)({error:"missing_api_key",message:"OpenAI API key tidak dikonfigurasi."},500);let r=await (0,o.zr)(e)||{},{imageBase64:n,images:t}=r,i=[];if(Array.isArray(t)&&t.length>0?i=t.filter(e=>"string"==typeof e&&e.length>16).map(e=>`data:image/jpeg;base64,${e}`):"string"==typeof n&&n.length>16&&(i=[`data:image/jpeg;base64,${n}`]),0===i.length)return(0,o.wE)({error:"imageBase64 or images[] is required"},400);let s=Date.now()-m;if(s<5e3)return(0,o.wE)({error:"cooldown",cooldown_ms:5e3-s},429);if(d)return(0,o.wE)({error:"server_busy",cooldown_ms:5e3},429);d=!0,m=Date.now();let l=`
Kamu adalah sistem klasifikasi sampah untuk konteks Indonesia.
Kamu akan menerima hingga EMPAT gambar dari frame yang sama:
- "tight": crop ketat area tengah (60%)
- "center": crop tengah (80%)
- "wide": crop lebar (90%)
- "hand-object": crop khusus objek di tangan

FOKUS PADA OBJEK YANG DIPEGANG TANGAN, bukan tangan itu sendiri.
Analisis objek yang paling dominan dan jelas terlihat.

Prioritas klasifikasi:
1) "merah" (B3): baterai, powerbank, lampu neon, elektronik kecil
2) "hijau" (organik): sisa makanan, sayur, buah, daun, tisu kotor
3) "biru" (kertas): kertas & kardus (bersih atau sedikit kotor)
4) "kuning" (anorganik): plastik, logam, kaca, kemasan
5) "abu-abu" (residu): popok, pembalut, foam, serpihan campuran

ATURAN KHUSUS:
- Jika ada objek jelas di tangan -> klasifikasi objek tersebut
- Jika objek di tangan adalah kertas -> "biru" (meskipun ada tangan)
- Jika hanya tangan tanpa objek -> "abu-abu"
- Abaikan tangan, fokus pada objek yang dipegang

Berikan respons dalam format JSON SAJA tanpa markdown:
{
  "category": "hijau" | "merah" | "biru" | "kuning" | "abu-abu",
  "confidence": 0.0 - 1.0,
  "bin_name": "Nama Tong (mis: Organik)",
  "bin_color": "Warna (mis: hijau)",
  "dominant_class": "Nama benda spesifik (mis: Botol Plastik, Kulit Pisang)",
  "reason": "Alasan singkat mengapa masuk kategori ini",
  "fun_fact": "Satu fakta unik/menarik tentang sampah ini (maks 1 kalimat)",
  "recycling_advice": "Saran singkat cara mengolah/membuang (maks 2 kalimat singkat)",
  "youtube_query": "Keyword pencarian video tutorial kreatif (mis: 'kerajinan botol plastik bekas', 'cara daur ulang kardus')"
}
`,g=i.map(e=>({type:"image_url",image_url:{url:e}})),p=await u.fr.chat.completions.create({model:"gpt-4o-mini",temperature:.2,max_tokens:250,messages:[{role:"system",content:l},{role:"user",content:g}]}),f=p.choices?.[0]?.message?.content||"{}",k={category:"abu-abu",reason:"tidak jelas",confidence:.7,fun_fact:null,recycling_advice:null};try{let e=f.match(/\{[\s\S]*\}/)?.[0];if(e){let a=(e.match(/\{/g)||[]).length,r=(e.match(/\}/g)||[]).length;a>r&&(e.endsWith('"')||e.endsWith("}")||(e+='"'),e+="}".repeat(a-r));let n=JSON.parse(e);"string"==typeof n.category&&(k.category=n.category),"string"==typeof n.reason&&(k.reason=n.reason),"number"==typeof n.confidence&&(k.confidence=Math.max(0,Math.min(1,n.confidence))),"string"==typeof n.fun_fact&&(k.fun_fact=n.fun_fact),"string"==typeof n.recycling_advice&&(k.recycling_advice=n.recycling_advice),"string"==typeof n.youtube_query&&(k.youtube_query=n.youtube_query),"string"==typeof n.dominant_class&&(k.dominant_class=n.dominant_class)}}catch(e){console.warn("JSON parsing error:",e.message),console.warn("Raw response:",f)}let y=(k.category||"abu-abu").toLowerCase(),h=k.confidence??.85,b={hijau:"Organik",kuning:"Anorganik",merah:"B3",biru:"Kertas","abu-abu":"Residu"}[y]||"Residu",_={dominant_class:k.dominant_class||b,bin:y,confidence:h,reason:k.reason,fun_fact:k.fun_fact,recycling_advice:k.recycling_advice,youtube_query:k.youtube_query};console.log("AI response (raw):",f),console.log("Parsed education data:",{fun_fact:k.fun_fact,recycling_advice:k.recycling_advice});let A=[{class:b,confidence:h,bbox:{x:.22,y:.22,w:.56,h:.56},waste_type:b,bin:y}],w=r.userEmail||e.headers.get("x-user-email");return w&&c.OQ&&(0,c.Oo)(w,{category:y,bin_name:b,confidence:h,reason:k.reason}).catch(e=>{console.warn("Failed to save detection to Supabase (non-blocking):",e.message)}),(0,o.wE)({detections:A,decision:_})}catch(e){if(d=!1,e?.status===429)return(0,o.wE)({error:"openai_rate_limit",cooldown_ms:12e3,message:"Terlalu banyak permintaan ke OpenAI. Silakan tunggu beberapa saat."},429);if(e?.message?.includes("API key")||e?.message?.includes("Missing credentials"))return console.error("OPENAI_API_KEY error:",e.message),(0,o.wE)({error:"missing_api_key",message:"OpenAI API key tidak valid. Pastikan OPENAI_API_KEY sudah dikonfigurasi di file .env"},500);return console.error("Classification error:",e),(0,o.wE)({error:"classification_error",message:e?.message||"Terjadi kesalahan saat memproses deteksi sampah"},500)}finally{d=!1}}let f=new t.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/classify/route",pathname:"/classify",filename:"route",bundlePath:"app/classify/route"},resolvedPagePath:"D:\\Semester 3\\FSD\\SampahKuPilah - Copy\\SampahKuPilah\\app\\classify\\route.js",nextConfigOutput:"",userland:n}),{requestAsyncStorage:k,staticGenerationAsyncStorage:y,serverHooks:h}=f,b="/classify/route";function _(){return(0,s.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:y})}},4664:(e,a,r)=>{r.d(a,{U1:()=>i,wE:()=>t,zr:()=>s});let n={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET,POST,PUT,DELETE,OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization, X-User-Email"};function t(e,a=200,r={}){return new Response(JSON.stringify(e),{status:a,headers:{"Content-Type":"application/json",...n,...r}})}function i(){return new Response(null,{status:204,headers:n})}async function s(e){try{return await e.json()}catch{return null}}},9665:(e,a,r)=>{r.d(a,{JA:()=>s,fr:()=>i});var n=r(8820);let t=process.env.OPENAI_API_KEY?.trim()||"";process.env.OPENAI_MODEL?.trim();let i=t?new n.ZP({apiKey:t}):null;function s(){return t?!function(e){if(!e)return!1;let a=e.toLowerCase();return a.includes("your_")||a.includes("example")||a.includes("placeholder")||e.length<20}(t)?{ok:!0}:{ok:!1,error:"invalid_api_key",message:"OpenAI API key tidak valid atau masih placeholder. Edit file .env dengan API key yang valid"}:{ok:!1,error:"missing_api_key",message:"OpenAI API key tidak dikonfigurasi. Pastikan OPENAI_API_KEY sudah diset di file .env"}}},8387:(e,a,r)=>{r.d(a,{Ix:()=>d,NF:()=>t,OQ:()=>u,Oo:()=>g,Qr:()=>m,R:()=>c,WB:()=>l,mI:()=>p});var n=r(4128);let t=process.env.SUPABASE_URL?.trim()||"",i=process.env.SUPABASE_SERVICE_ROLE?.trim()||process.env.SUPABASE_SERVICE_KEY?.trim()||"",s=process.env.SUPABASE_ANON_KEY?.trim()||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2c2VhZWhmcXJ4emt2b2VqZ3VqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MzI2NjYsImV4cCI6MjA3OTEwODY2Nn0.Jp9SN_U-xJBay1uhyiGVKbyF9Tjsuse5QxHiBeH5S7U".trim()||"",o=i||s,u=t&&o?(0,n.eI)(t,o):null,c=e=>"string"==typeof e?e.trim().toLowerCase():"";async function l(e){if(!u)return null;try{let a=c(e),{data:r,error:n}=await u.from("users").select("*").eq("email",a).single();if(n)return"PGRST116"!==n.code&&console.error("Error finding user in Supabase:",n),null;return r}catch(e){return console.error("Exception finding user in Supabase:",e),null}}async function d(e){if(!u)return null;try{let{data:a,error:r}=await u.from("users").insert({email:c(e.email),password_hash:e.passwordHash||null,provider:e.provider||"local",name:e.name||null,picture:e.picture||null}).select().single();if(r)return console.error("Error creating user in Supabase:",r),null;return a}catch(e){return console.error("Exception creating user in Supabase:",e),null}}async function m(e){if(!t||!i)return null;try{let a=c(e),r=await fetch(`${t}/auth/v1/admin/users`,{method:"GET",headers:{apikey:i,Authorization:`Bearer ${i}`,"Content-Type":"application/json"}});if(r.ok){let e=await r.json();if(e?.users&&Array.isArray(e.users)){let r=e.users.find(e=>e.email&&e.email.toLowerCase()===a);if(r?.id)return console.log(`Found auth user for ${a}: ${r.id}`),r.id}}else{let e=await r.text();console.warn("Error listing auth users:",e.substring(0,200))}let n=await fetch(`${t}/auth/v1/admin/users`,{method:"POST",headers:{apikey:i,Authorization:`Bearer ${i}`,"Content-Type":"application/json"},body:JSON.stringify({email:a,email_confirm:!0,user_metadata:{}})});if(n.ok){let e=await n.json();if(e?.user?.id)return console.log(`Created auth user for ${a}: ${e.user.id}`),e.user.id}else{let e=await n.text();console.error("Error creating auth user:",e.substring(0,200))}return console.warn(`Auth user ID not found/created for ${a}`),null}catch(e){return console.error("Error getting/creating auth user ID:",e.message),null}}async function g(e,a){if(!u)return null;try{let{data:r,error:n}=await u.from("detections").insert({user_email:c(e),category:a.category||a.bin||"abu-abu",bin_name:a.bin_name||a.dominant_class||"Residu",confidence:a.confidence||.8,reason:a.reason||"Auto-detected",created_at:new Date().toISOString()}).select().single();if(n)return console.error("Error saving detection to Supabase:",n),null;return console.log("Detection saved to Supabase:",r.id),r}catch(e){return console.error("Exception saving detection to Supabase:",e),null}}async function p(e,a=50){if(!u)return[];try{let{data:r,error:n}=await u.from("detections").select("*").eq("user_email",c(e)).order("created_at",{ascending:!1}).limit(a);if(n)return console.error("Error fetching detections from Supabase:",n),[];return r||[]}catch(e){return console.error("Exception fetching detections from Supabase:",e),[]}}}};var a=require("../../webpack-runtime.js");a.C(e);var r=e=>a(a.s=e),n=a.X(0,[948,885,209],()=>r(5579));module.exports=n})();